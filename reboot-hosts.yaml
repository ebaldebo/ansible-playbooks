---
- name: Restart all hosts excluding control node and ensure they're up
  hosts: all
  serial: 1
  tasks:
    - name: Gather facts
      setup:

    - block:
        - name: Restart host
          become: true
          reboot:
            reboot_timeout: 300
            pre_reboot_delay: 0
            post_reboot_delay: 30
            test_command: uptime
      when: ansible_host != ansible_default_ipv4.address

  rescue:
    - name: Send Discord message
      uri:
        url: "{{ lookup('env', 'DISCORD_REBOOT_FAILED_WEBHOOK') }}"
        method: POST
        headers:
          Content-Type: "application/json"
        body_format: json
        body: '{"content": "@everyone Reboot failed on {{ ansible_host | default(inventory_hostname) }}: {{ ansible_failed_result }}!"}'
      delegate_to: localhost

- name: Reboot the control node
  hosts: localhost
  tasks:
    - name: Delayed reboot control node
      become: true
      shell: "shutdown -r +1"
